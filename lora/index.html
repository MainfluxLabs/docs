<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://mainfluxlabs.github.io/lora/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>LoRa - MainfluxLabs</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "LoRa";
        var mkdocs_page_input_path = "lora.md";
        var mkdocs_page_url = "/lora/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> MainfluxLabs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Overview</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../getting-started/">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../provision.md">Provision</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../messaging/">Messaging</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../storage/">Storage</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">LoRa</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#run-lora-server">Run Lora Server</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#setup-lora-server">Setup LoRa Server</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mainflux-and-lora-server">Mainflux and LoRa Server</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#route-map">Route Map</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#messaging">Messaging</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../edge/">Edge</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../authentication/">Authentication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../authorization/">Authorization</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cli/">CLI</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../api/">API</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../groups/">Groups</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../tracing/">Tracing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../dev-guide/">Developer's Guide</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubernetes/">Kubernetes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../benchmark/">Benchmark</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">MainfluxLabs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">LoRa</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lora">LoRa<a class="headerlink" href="#lora" title="Permanent link">#</a></h1>
<p>Bridging with LoRaWAN Networks can be done over the <a href="https://github.com/MainfluxLabs/mainflux/tree/master/lora">lora-adapter</a>. This service sits between Mainflux and <a href="https://www.loraserver.io">LoRa Server</a> and just forwards the messages from one system to another via MQTT protocol, using the adequate MQTT topics and in the good message format (JSON and SenML), i.e. respecting the APIs of both systems.</p>
<p>LoRa Server is used for connectivity layer. Specially for the <a href="https://www.loraserver.io/lora-gateway-bridge/overview/">LoRa Gateway Bridge</a> service, which abstracts the <a href="https://github.com/Lora-net/packet_forwarder/blob/master/PROTOCOL.TXT">SemTech packet-forwarder UDP protocol</a> into JSON over MQTT. But also for the <a href="https://www.loraserver.io/loraserver/overview">LoRa Server</a> service,  responsible of the de-duplication and handling of uplink frames received by the gateway(s), handling of the LoRaWAN mac-layer and scheduling of downlink data transmissions. Finally the <a href="https://www.loraserver.io/lora-app-server/overview/">Lora App Server</a> services is used to interact with the system.</p>
<h2 id="run-lora-server">Run Lora Server<a class="headerlink" href="#run-lora-server" title="Permanent link">#</a></h2>
<p>Before to run the <code>lora-adapter</code> you must install and run LoRa Server. First, execute the following command:</p>
<pre><code class="language-bash">go get github.com/brocaar/loraserver-docker
</code></pre>
<p>Once everything is installed, execute the following command from the LoRa Server project root:</p>
<pre><code class="language-bash">docker-compose up
</code></pre>
<p><strong>Troubleshouting:</strong> Mainflux and LoRa Server use their own MQTT brokers which by default occupy MQTT port <code>1883</code>. If both are ran on the same machine different ports must be used. You can fix this on Mainflux side by configuring the environment variable <code>MF_MQTT_ADAPTER_MQTT_PORT</code>.</p>
<h2 id="setup-lora-server">Setup LoRa Server<a class="headerlink" href="#setup-lora-server" title="Permanent link">#</a></h2>
<p>Now that both systems are running you must provision LoRa Server, which offers for integration with external services, a RESTful and gRPC API. You can do it as well over the <a href="https://www.loraserver.io/lora-app-server/overview">LoRa App Server</a>, which is good example of integration.</p>
<ul>
<li><strong>Create an Organization:</strong> To add your own Gateways to the network you must have an Organization.</li>
<li><strong>Create a Network:</strong> Set the address of your Network-Server API that is used by LoRa App Server or other custom components interacting with LoRa Server (by default loraserver:8000).</li>
<li><strong>Create a Gateways-Profile:</strong> In this profile you can select the radio LoRa channels and the LoRa Network Server to use.</li>
<li><strong>Create a Service-profile:</strong> A service-profile connects an organization to a network-server and defines the features that an organization can use on this Network-Server.</li>
<li><strong>Create a Gateway:</strong> You must set proper ID in order to be discovered by LoRa Server.</li>
<li><strong>Create an Application:</strong> This will allows you to create Devices by connecting them to this application. This is equivalent to Devices connected to channels in Mainflux.</li>
<li><strong>Create a Device-Profile:</strong> Before creating Device you must create Device profile where you will define some parameter as LoRaWAN MAC version (format of the device address) and the LoRaWAN regional parameter (frequency band). This will allow you to create many devices using this profile.</li>
<li><strong>Create a Device:</strong> Finally, you can create a Device. You must configure the <code>network session key</code> and <code>application session key</code> of your Device. You can generate and copy them on your device configuration or you can use your own pre generated keys and set them using the LoRa App Server UI.
Device connect through OTAA. Make sure that loraserver device-profile is using same release as device. If MAC version is 1.0.X, <code>application key = app_key</code> and <code>app_eui = deviceEUI</code>. If MAC version is 1.1 or ABP both parameters will be needed, APP_key and Network key.</li>
</ul>
<h2 id="mainflux-and-lora-server">Mainflux and LoRa Server<a class="headerlink" href="#mainflux-and-lora-server" title="Permanent link">#</a></h2>
<p>Once everything is running and the LoRa Server is provisioned, execute the following command from Mainflux project root to run the lora-adapter:</p>
<pre><code class="language-bash">docker-compose -f docker/addons/lora-adapter/docker-compose.yml up -d
</code></pre>
<p><strong>Troubleshouting:</strong>  The lora-adapter subscribes to the LoRa Server MQTT broker and will fail if the connection is not established. You must ensure that the environment variable <code>MF_LORA_ADAPTER_MESSAGES_URL</code> is propertly configured.</p>
<p><strong>Remark:</strong> By defaut, <code>MF_LORA_ADAPTER_MESSAGES_URL</code> is set as <code>tcp://lora.mqtt.mainfluxlabs.io:1883</code> in the <a href="https://github.com/MainfluxLabs/mainflux/blob/master/docker/addons/lora-adapter/docker-compose.yml">docker-compose.yml</a> file of the adapter. If you run the composition without configure this variable you will start to receive messages from our demo server.</p>
<h3 id="route-map">Route Map<a class="headerlink" href="#route-map" title="Permanent link">#</a></h3>
<p>The lora-adapter use <a href="https://redis.io/">Redis</a> database to create a route map between both systems. As in Mainflux we use Channels to connect Things, LoRa Server uses Applications to connect Devices.</p>
<p>The lora-adapter uses the matadata of provision events emitted by Mainflux system to update his route map. For that, you must provision Mainflux Channels and Things with an extra metadata key in the JSON Body of the HTTP request. It must be a JSON object with key <code>lora</code> which value is another JSON object. This nested JSON object should contain <code>app_id</code> or <code>dev_eui</code> field. In this case <code>app_id</code> or <code>dev_eui</code> must be an existent Lora application ID or device EUI:</p>
<p><strong>Channel structure:</strong></p>
<pre><code>{
  &quot;name&quot;: &quot;&lt;channel name&gt;&quot;,
  &quot;metadata:&quot;: {
    &quot;lora&quot;: {
      &quot;app_id&quot;: &quot;&lt;application ID&gt;&quot;
    }
  }
}
</code></pre>
<p><strong>Thing structure:</strong></p>
<pre><code>{
  &quot;type&quot;: &quot;device&quot;,
  &quot;name&quot;: &quot;&lt;thing name&gt;&quot;,
  &quot;metadata:&quot;: {
    &quot;lora&quot;: {
      &quot;dev_eui&quot;: &quot;&lt;device EUI&gt;&quot;
    }
  }
}
</code></pre>
<h5 id="messaging">Messaging<a class="headerlink" href="#messaging" title="Permanent link">#</a></h5>
<p>To forward LoRa messages the lora-adapter subscribes to topics <code>applications/+/devices/+</code> of the LoRa Server MQTT broker. It verifies the <code>app_id</code> and the <code>dev_eui</code> of received messages. If the mapping exists it uses corresponding <code>Channel ID</code> and <code>Thing ID</code> to sign and forwards the content of the LoRa message to the Mainflux message broker.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../storage/" class="btn btn-neutral float-left" title="Storage"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../edge/" class="btn btn-neutral float-right" title="Edge">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright (c) MainfluxLabs</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/MainfluxLabs/docs" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../storage/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../edge/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
